openapi: 3.0.3
info:
  title: API Gateway Switch Transaccional
  description: |
    API Gateway para la interacción entre Bancos y el Switch Transaccional.
    Maneja transferencias, consultas de cuentas, devoluciones y compensación.

    **Última actualización:** 2026-02-13

    **Rutas principales:**
    - `/api/v2/switch/*` - Nucleo (transferencias, account-lookup, returns)
    - `/api/v2/switch/funding` - Fondeo (proxy a Contabilidad)
    - `/api/v2/switch/admin/*` - BFF Admin (proxy a Directorio/Contabilidad)
    - `/api/v2/compensation/*` - Compensación

    **Rutas BFF Administrativas (via Nucleo):**
    - `GET  /api/v2/switch/admin/instituciones` - Listar bancos
    - `POST /api/v2/switch/admin/instituciones` - Crear banco
    - `POST /api/v2/switch/admin/ledger/cuentas` - Crear cuenta técnica
    - `POST /api/v2/switch/admin/funding/recharge` - Fondear cuenta

    **Rutas legacy (no desplegadas en APIM):**
    - `/api/v1/funding/*` - Contabilidad directa
    - `/api/v1/instituciones/*` - Directorio directo
    - `/api/v1/transacciones/callback` - Callbacks de bancos
  version: 2.0.0
  contact:
    name: Equipo de Infraestructura
    email: soporte@digiconecu.com

servers:
  - url: https://api.dev.digiconecu.com
    description: Servidor de Desarrollo
  - url: https://api.staging.digiconecu.com
    description: Servidor de Staging
  - url: https://api.digiconecu.com
    description: Servidor de Producción

components:
  securitySchemes:
    CognitoAuth:
      type: oauth2
      flows:
        clientCredentials:
          tokenUrl: https://auth.switch-api.com/oauth2/token
          scopes:
            https://switch-api.com/transfers.write: Permiso de escritura para transferencias

  schemas:
    TransferRequest:
      type: object
      required:
        - instructionId
        - amount
        - currency
        - debtorAccount
        - creditorAccount
      properties:
        instructionId:
          type: string
          example: "20230915123456789"
        amount:
          type: number
          format: double
          example: 150.00
        currency:
          type: string
          example: "USD"
        debtorAccount:
          type: string
          example: "1234567890"
        creditorAccount:
          type: string
          example: "0987654321"

    TransferResponse:
      type: object
      properties:
        status:
          type: string
          example: "ACCEPTED"
        transactionId:
          type: string
          example: "TX-987654321"

    AccountLookupRequest:
      type: object
      required:
        - accountNumber
        - bankId
      properties:
        accountNumber:
          type: string
          example: "1234567890"
        bankId:
          type: string
          example: "BANCO001"

    AccountLookupResponse:
      type: object
      properties:
        accountName:
          type: string
          example: "Juan Pérez"
        status:
          type: string
          example: "ACTIVE"

    ReturnRequest:
      type: object
      required:
        - originalInstructionId
        - reasonCode
      properties:
        originalInstructionId:
          type: string
          example: "20230915123456789"
        reasonCode:
          type: string
          example: "AC03"

    FundingResponse:
      type: object
      properties:
        balance:
          type: number
          example: 50000.00
        currency:
          type: string
          example: "USD"
        lastUpdated:
          type: string
          format: date-time

    InstitutionDTO:
      type: object
      properties:
        bic:
          type: string
          example: "ARCBECEGXXX"
        nombre:
          type: string
          example: "ArcBank"
        pais:
          type: string
          example: "EC"
        cuentaTecnica:
          type: object
        interruptorCircuito:
          type: object

    CallbackRequest:
      type: object
      required:
        - header
        - body
      properties:
        header:
          type: object
          properties:
            respondingBankId:
              type: string
              example: "ARCBECEGXXX"
        body:
          type: object
          properties:
            originalInstructionId:
              type: string
              example: "20230915123456789"
            status:
              type: string
              example: "COMPLETED"
              enum: [COMPLETED, REJECTED, PENDING]

security:
  - CognitoAuth:
      - https://switch-api.com/transfers.write

paths:
  # Microservicio Nucleo

  /api/v2/switch/transfers:
    post:
      summary: Crear transferencia (pacs.008)
      operationId: createTransfer
      tags:
        - Transferencias
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/TransferRequest"
      responses:
        "201":
          description: Transferencia aceptada
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/TransferResponse"
        "400":
          description: Datos inválidos
        "401":
          description: No autorizado

  /api/v2/switch/transfers/{instructionId}:
    get:
      summary: Consultar estado de transferencia
      operationId: getTransferStatus
      tags:
        - Transferencias
      parameters:
        - name: instructionId
          in: path
          required: true
          schema:
            type: string
      responses:
        "200":
          description: Estado de la transferencia
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/TransferResponse"

  /api/v2/switch/account-lookup:
    post:
      summary: Consulta de Titularidad (Account Lookup)
      operationId: accountLookup
      tags:
        - Cuentas
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/AccountLookupRequest"
      responses:
        "200":
          description: Datos de la cuenta
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/AccountLookupResponse"

  /api/v2/switch/returns:
    post:
      summary: Procesar Devolución/Reverso (pacs.004)
      operationId: processReturn
      tags:
        - Devoluciones
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/ReturnRequest"
      responses:
        "202":
          description: Devolución aceptada par procesamiento

  /api/v2/switch/funding:
    post:
      summary: Fondear cuenta (proxy directo a Contabilidad)
      operationId: fundAccount
      tags:
        - Fondeo
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                bic:
                  type: string
                  example: "ARCBANK"
                monto:
                  type: number
                  example: 1000.00
                idInstruccion:
                  type: string
                  format: uuid
      responses:
        "200":
          description: Fondeo exitoso
        "400":
          description: Datos inválidos

  /api/v2/switch/health:
    get:
      summary: Health Check - Ms Nucleo
      security: []
      tags:
        - Health
      responses:
        "200":
          description: Servicio saludable

  # BFF Admin Endpoints (proxy via Nucleo)

  /api/v2/switch/admin/instituciones:
    get:
      summary: Listar bancos (BFF Admin)
      description: Proxy a ms-directorio para listar instituciones registradas
      operationId: adminListInstitutions
      tags:
        - Admin BFF
      responses:
        "200":
          description: Lista de bancos
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: "#/components/schemas/InstitutionDTO"
    post:
      summary: Crear banco (BFF Admin)
      description: Proxy a ms-directorio para registrar nueva institución
      operationId: adminCreateInstitution
      tags:
        - Admin BFF
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/InstitutionDTO"
      responses:
        "200":
          description: Banco creado

  /api/v2/switch/admin/ledger/cuentas:
    post:
      summary: Crear cuenta técnica (BFF Admin)
      description: Proxy a ms-contabilidad para inicializar cuentas de liquidación
      operationId: adminCreateLedgerAccount
      tags:
        - Admin BFF
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                codigoBic:
                  type: string
                  example: "ARCBANK"
                saldoInicial:
                  type: number
                  example: 50000.00
      responses:
        "200":
          description: Cuenta técnica creada

  /api/v2/switch/admin/funding/recharge:
    post:
      summary: Fondear cuenta (BFF Admin)
      description: Proxy a ms-contabilidad para recargar saldo de un banco
      operationId: adminFundRecharge
      tags:
        - Admin BFF
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                bic:
                  type: string
                  example: "ARCBANK"
                monto:
                  type: number
                  example: 10000.00
                idInstruccion:
                  type: string
                  format: uuid
      responses:
        "200":
          description: Recarga exitosa

  /api/v2/transfers/health:
    get:
      summary: Health Check - Alias de compatibilidad
      description: Ruta alternativa que redirige a /api/v2/switch/health
      security: []
      tags:
        - Health
      responses:
        "200":
          description: Servicio saludable

  # Microservicio Compensacion

  /api/v2/compensation/upload:
    post:
      summary: Carga de archivos de compensación
      operationId: uploadCompensationFile
      tags:
        - Compensación
      requestBody:
        content:
          multipart/form-data:
            schema:
              type: object
              properties:
                file:
                  type: string
                  format: binary
      responses:
        "202":
          description: Archivo recibido

  /api/v2/compensation/health:
    get:
      summary: Health Check - Ms Compensacion
      security: []
      tags:
        - Health
      responses:
        "200":
          description: Servicio saludable

  # Microservicio Contabilidad

  /api/v1/funding/recharge:
    post:
      summary: Recargar Fondos (Banco Central)
      operationId: rechargeFunds
      tags:
        - Fondeo
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                bic:
                  type: string
                  example: "ARCBECEGXXX"
                monto:
                  type: number
                  example: 100000.00
                idInstruccion:
                  type: string
                  example: "RECARGA-001"
      responses:
        "200":
          description: Recarga exitosa
          content:
            application/json:
              schema:
                type: object
                properties:
                  bic:
                    type: string
                  saldoActual:
                    type: number
                  ultimaRecarga:
                    type: number

  /api/v1/funding/available/{bic}/{monto}:
    get:
      summary: Verificar Disponibilidad de Fondos
      operationId: checkFundingAvailability
      tags:
        - Fondeo
      parameters:
        - name: bic
          in: path
          required: true
          schema:
            type: string
          example: "ARCBECEGXXX"
        - name: monto
          in: path
          required: true
          schema:
            type: number
          example: 5000.00
      responses:
        "200":
          description: Estado de disponibilidad
          content:
            application/json:
              schema:
                type: object
                properties:
                  bic:
                    type: string
                  disponible:
                    type: boolean
                  montoRequerido:
                    type: number

  # Microservicio Directorio

  /api/v1/instituciones:
    get:
      summary: Listar todas las instituciones bancarias
      operationId: listInstitutions
      tags:
        - Directorio
      security: []
      responses:
        "200":
          description: Lista de bancos participantes
          content:
            application/json:
              schema:
                type: array
                items:
                  type: object

  /api/v1/red/bancos:
    get:
      summary: Listar bancos - Alias de compatibilidad
      description: Ruta heredada que redirige a /api/v1/instituciones
      operationId: listBanks
      tags:
        - Directorio
      security: []
      responses:
        "200":
          description: Lista de bancos participantes
          content:
            application/json:
              schema:
                type: array
                items:
                  type: object

  /api/v1/instituciones/{bic}:
    get:
      summary: Obtener detalle de banco por BIC
      operationId: getInstitutionByBic
      tags:
        - Directorio
      security: []
      parameters:
        - name: bic
          in: path
          required: true
          schema:
            type: string
          example: "ARCBECEGXXX"
      responses:
        "200":
          description: Datos del banco
          content:
            application/json:
              schema:
                type: object

  /api/v1/lookup/{bin}:
    get:
      summary: Descubrir banco destino por BIN (Routing)
      operationId: lookupByBin
      tags:
        - Directorio
      security: []
      parameters:
        - name: bin
          in: path
          required: true
          schema:
            type: string
          example: "456789"
      responses:
        "200":
          description: Banco identificado
        "503":
          description: Banco fuera de servicio (circuito abierto)

  # Callbacks (Nucleo)

  /api/v1/transacciones/callback:
    post:
      summary: Recibir callback de banco destino
      description: Endpoint para que los bancos notifiquen resultado de procesamiento
      operationId: receiveCallback
      tags:
        - Callbacks
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                header:
                  type: object
                  properties:
                    respondingBankId:
                      type: string
                body:
                  type: object
                  properties:
                    originalInstructionId:
                      type: string
                    status:
                      type: string
      responses:
        "200":
          description: Callback procesado

  /api/v1/transacciones/callback/health:
    get:
      summary: Health check del callback endpoint
      operationId: callbackHealth
      tags:
        - Health
      security: []
      responses:
        "200":
          description: Endpoint disponible
